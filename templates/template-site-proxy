# REVERSE PROXY NGINX CONFIGURATION by Webinoly

location / {
	# Set the Host header to $host in case you want to preserve the original host value. (proxy_set_header Host $host;)
	# Set the Host header to match the destination server (may be needed) to connect with external resources. (proxy_set_header Host 'your.s3.us-east-1.amazonaws.com';)
	# The latest can't be used with multiple destinations or load-balancing, which is one of the main features of nginx upstreams.
	# The purpose of the Host header in to indicate to the remote server which website you are trying to access and is critical if an IP address is being shared with multiple sites.
	#proxy_set_header Host $host;
	#proxy_set_header X-Forwarded-Host $host;
	#proxy_set_header X-Forwarded-Server $host;
	#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	#proxy_set_header X-Forwarded-Proto $scheme;
	#proxy_set_header X-Real-IP $remote_addr;
	
	# https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Upgrade
	# It can be used by a client to upgrade a connection from HTTP 1.1 to HTTP 2.0, or an HTTP or HTTPS connection into a WebSocket.
	# We prefer 1.1 and keepalive because nginx don't have support for 2.0 in proxy/upstream - https://trac.nginx.org/nginx/ticket/923
	# For Upgrade, should be set Connection "upgrade" below and keepalive disabled in the upstream.
	#proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection "";
	proxy_http_version 1.1;

	proxy_connect_timeout 300;
	proxy_send_timeout    300;
	proxy_read_timeout    300;
	proxy_ignore_headers   Set-Cookie;
	proxy_intercept_errors on;
	#proxy_next_upstream error timeout http_500;
	
	# Upstream defined here: conf.d/upstream_proxy.conf
	proxy_pass <upstream_name>;
		
	# CacheStaticFiles
	location ~* \.(css|xml|gif|jpeg|jpg|js|atom|rss|mml|txt|jad|wml|htc|avif|png|svg|svgz|tif|tiff|wbmp|webp|ico|jng|bmp|woff|woff2|jar|war|ear|json|hqx|doc|pdf|ps|eps|ai|rtf|m3u8|kml|kmz|xls|eot|ppt|odg|odp|ods|odt|pptx|xlsx|docx|wmlc|wasm|7z|cco|jardiff|jnlp|run|pl|pm|prc|pdb|rar|rpm|sea|swf|sit|tcl|tk|der|pem|crt|xpi|xhtml|xspf|zip|bin|exe|dll|deb|dmg|iso|img|msi|msp|msm|mid|midi|kar|mp3|ogg|m4a|ra|3gpp|3gp|ts|mp4|mpeg|mpg|mov|webm|flv|m4v|mng|asx|asf|wmv|avi|ogv|otf|ttf|tgz|gz|bz2|tar|wav|cur|heic|aac|webmanifest|cast)$ {
		include common/headers-http.conf;
		include common/headers-https.conf;
		add_header "Access-Control-Allow-Origin" "*";
		access_log off;
		log_not_found off;
		expires max;
		
		proxy_pass <upstream_name>;
	}
	
	# BasicLocationRootFiles
	location = /robots.txt {
		access_log off;
		log_not_found off;
		
		proxy_pass <upstream_name>;
	}
	# BasicLocEnd
}
